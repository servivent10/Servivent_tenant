-- =============================================================================
-- NOTIFICATIONS FOREIGN KEY FIX (V1)
-- =============================================================================
-- This script fixes a "violates foreign key constraint" error on the
-- `notificaciones` table that occurs when a notification is generated by a
-- non-tenant user, such as a customer placing a web order.
--
-- PROBLEM:
-- The `notificaciones.usuario_generador_id` column had a foreign key constraint
-- referencing `public.usuarios(id)`. When a web customer's action triggered a
-- notification, the system tried to insert the customer's `auth.uid()`, which
-- doesn't exist in `public.usuarios`, causing the entire transaction to fail.
-- This is identical to the issue previously fixed for the `historial_cambios` table.
--
-- SOLUTION:
-- The foreign key constraint on `notificaciones.usuario_generador_id` is removed.
-- The column is preserved to store the actor's ID, but the database no longer
-- enforces that this ID must exist in the `public.usuarios` table, making the
-- notification system compatible with all user types.
--
-- INSTRUCTIONS:
-- Execute this script completely in your Supabase SQL Editor.
-- =============================================================================

-- Step 1: Drop the foreign key constraint from the `notificaciones` table.
ALTER TABLE public.notificaciones
DROP CONSTRAINT IF EXISTS notificaciones_usuario_generador_id_fkey;

-- =============================================================================
-- End of script.
-- =============================================================================
